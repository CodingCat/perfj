# PerfJ

PerfJ is a wrapper of linux `perf` for java programs.

This project is based on Johannes Rudolph's work at [here](https://github.com/jrudolph/perf-map-agent). I just make it more convenient to use.

## Build

    gradle releaseTarGz
or just run once

    gradle createWrapper
afterwards run

    ./gradlew releaseTarGz

## Usage

`PerfJ` is only work on jdk version with frame pointer preserved. Thanks to [Brendan Gregg's patch](https://bugs.openjdk.java.net/browse/JDK-8068945). We will have this awesome feature on JDK 8u60. Here is an example shows how to enable this feature

    java -XX:+PreserveFramePointer ContextSwitchTest

After that, run perfj

    bin/perfj record -e cycles -F 99 -g -p `pgrep -f ContextSwitchTest` sleep 5

We will see perf.data as well as /tmp/perf-$pid.map are generated by perfj on local disk. Finally, show the result

    bin/perfj report --stdio

Below is an example result

```
# ========
# captured on: Mon Jun  8 16:54:55 2015
# hostname : mzhou-server
# os release : 3.13.0-49-generic
# perf version : 3.13.11-ckt17
# arch : x86_64
# nrcpus online : 8
# nrcpus avail : 8
# cpudesc : Intel(R) Core(TM) i7-4770 CPU @ 3.40GHz
# cpuid : GenuineIntel,6,60,3
# total memory : 32887248 kB
# cmdline : /usr/lib/linux-tools-3.13.0-49/perf record -e sched:sched_switch -F
# event : name = sched:sched_switch, type = 2, config = 0x130, config1 = 0x0, co
# HEADER_CPU_TOPOLOGY info available, use -I to display
# HEADER_NUMA_TOPOLOGY info available, use -I to display
# pmu mappings: cpu = 4, software = 1, tracepoint = 2, breakpoint = 5
# ========
#
# Samples: 197K of event 'sched:sched_switch'
# Event count (approx.): 197547
#
# Overhead  Command      Shared Object          Symbol
# ........  .......  .................  ..............
#
   100.00%     java  [kernel.kallsyms]  [k] __schedule
               |
               --- __schedule
                  |
                  |--99.97%-- schedule
                  |          futex_wait_queue_me
                  |          futex_wait
                  |          do_futex
                  |          sys_futex
                  |          system_call_fastpath
                  |          |
                  |          |--99.96%-- pthread_cond_wait@@GLIBC_2.3.2
                  |          |          Unsafe_Park
                  |          |          Lsun/misc/Unsafe;.park
                  |          |          LContextSwitchTest$WorkerThread;.run
                  |          |          call_stub
                  |          |          JavaCalls::call_helper(JavaValue*, metho
                  |          |          JavaCalls::call_virtual(JavaValue*, Klas
                  |          |          JavaCalls::call_virtual(JavaValue*, Hand
                  |          |          thread_entry(JavaThread*, Thread*)
                  |          |          JavaThread::thread_main_inner()
                  |          |          java_start(Thread*)
                  |          |          start_thread
                  |           --0.04%-- [...]
                   --0.03%-- [...]



#
# (For a higher level overview, try: perf report --sort comm,dso)
#

```

## License

This library is licensed under GPLv2. See the LICENSE file.
